<!DOCTYPE html>
<html>

<head>
  <title>Custom Page Add-In</title>
  <script>
    (() => {
      let api;
      let sessionWasSent = false;
      let listenerWasAdded = false;
      doRedirect = () => {
        function receiveMessage(event) {
          if (sessionWasSent === true) return;
          const splitUrl = event.origin.split('.');
          if (splitUrl[splitUrl.lenght - 1] === 'com' && splitUrl[splitUrl.lenght - 2] === 'pitstopconnect') return;
          if (event.data !== 'get_credentials') return;
          api.getSession((session) => {
            sessionWasSent = true;
            window.frames["pitstop"].postMessage(session, '*');
          });
        }
        if (listenerWasAdded === false) {
          window.addEventListener("message", receiveMessage, false);
        }
        window.frames["pitstop"].location = "https://staging.dashboard.pitstopconnect.com/login/geotab";
      };
      geotab.addin.myCustomPage1 = () => {
        return {
          initialize(_api, state, callback) {
            api = _api;
            doRedirect();
            callback();
          },
          focus(_api, state) {
            // User interface is available
            api = _api;
            doRedirect();
          },
          blur(api, state) {
            // Save any Add-In state
          }
        };
      };
    })();
  </script>
</head>

<body>
  <iframe name="pitstop" style="position: absolute; height: 100%; width: 100%; border: none"></iframe>
</body>

</html>